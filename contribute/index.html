<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Đóng Góp Thông Tin Gia Phả</title>
  <!-- Cloudinary Widget JS -->
  <script src="https://upload-widget.cloudinary.com/global/all.js"></script>

<style>
  .hidden { display: none; }
    #preview { margin-top: 10px; }
    #preview img { max-width: 200px; }
    .error-message { color: red; margin-top: 5px; }
    .success-message { color: green; margin-top: 5px; }
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
    line-height: 1.6;
  }
  .form-group {
    margin-bottom: 15px;
  }
  label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
  }
  input[type="text"],
  input[type="email"],
  textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  textarea {
    min-height: 100px;
  }
  button {
    background: #4CAF50;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background: #45a049;
  }
  .hidden {
    display: none;
  }
  .error {
    color: red;
    font-size: 0.9em;
  }
  .contribute-button {
  display: inline-block;
  padding: 12px 24px;
  background-color: #4CAF50;
  color: white;
  text-decoration: none;
  border-radius: 4px;
  font-weight: bold;
  transition: background-color 0.3s;
}

.contribute-button:hover {
  background-color: #45a049;
}
</style>

</head>
<body>
  <form name="contribute" netlify action="/thank-you.html" netlify-honeypot="bot-field">
    <!-- Trường chống spam -->
    <p class="hidden">
      <label>Không điền vào đây: <input name="bot-field"></label>
    </p>
    
    <!-- Các trường thông tin -->
    <label>Họ tên: <input type="text" name="name" required></label>
    <label>Email: <input type="email" name="email" required></label>
    <label>Nội dung: <textarea name="message" required></textarea></label>

    <!-- Phần upload ảnh -->
    <label>Ảnh đính kèm:</label>
    <button type="button" id="upload-button">Chọn ảnh</button>
    <div id="preview"></div>
    <div id="upload-status" class="error-message"></div>
    
    <!-- Hidden fields để lưu URL ảnh và hiển thị trong email -->
    <input type="hidden" name="photo-url" id="photo-url">
    <input type="hidden" name="photo-html" id="photo-html">

    <button type="submit">Gửi đóng góp</button>
  </form>

  <script>
    // Cấu hình Cloudinary Widget
    const widget = cloudinary.createUploadWidget({
      cloudName: 'dmzxll8xc',
      uploadPreset: 'glk_upload', // Đã cấu hình là Unsigned
      sources: ['local', 'camera'],
      multiple: false,
      clientAllowedFormats: ['jpg', 'png', 'webp'],
      maxFileSize: 5000000, // 5MB
      cropping: false,
      showAdvancedOptions: false,
      styles: {
        palette: {
          window: "#FFFFFF",
          sourceBg: "#F4F4F5",
          windowBorder: "#90A0B3",
          tabIcon: "#000000",
          inactiveTabIcon: "#555A5F",
          menuIcons: "#555A5F",
          link: "#0433FF",
          action: "#339933",
          inProgress: "#0433FF",
          complete: "#339933",
          error: "#CC3333",
          textDark: "#000000",
          textLight: "#FFFFFF"
        }
      }
    }, (error, result) => {
      const statusElement = document.getElementById('upload-status');
      
      if (error) {
        statusElement.textContent = `Lỗi: ${error.message || 'Không thể tải ảnh lên'}`;
        statusElement.className = 'error-message';
        console.error('Upload error:', error);
        return;
      }

      if (result && result.event === 'success') {
        statusElement.textContent = 'Ảnh đã tải lên thành công!';
        statusElement.className = 'success-message';
        
        // Hiển thị preview
        document.getElementById('preview').innerHTML = `
          <img src="${result.info.secure_url}" alt="Ảnh đã tải lên">
        `;
        
        // Lưu URL vào hidden fields
        document.getElementById('photo-url').value = result.info.secure_url;
        document.getElementById('photo-html').value = 
          `<img src="${result.info.secure_url}" width="200" alt="Ảnh đóng góp">`;
      }
    });

    // Mở widget khi click nút
    document.getElementById('upload-button').addEventListener('click', () => {
      document.getElementById('upload-status').textContent = 'Đang chuẩn bị tải lên...';
      widget.open();
    });

    // Kiểm tra CORS
    document.addEventListener('DOMContentLoaded', () => {
      fetch('https://api.cloudinary.com/v1_1/dmzxll8xc/ping', { mode: 'cors' })
        .then(() => console.log('CORS configured properly'))
        .catch(err => console.warn('CORS check failed:', err));
    });
  </script>
</body>
</html>